<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>å¾®ä¿¡åç‰‡</title>
  <!-- å¼•å…¥äºŒç»´ç åº“ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* === å…¨å±€æ ·å¼ === */
    :root { --bg-wx: #ededed; --green: #07c160; --dark: #191919; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    body, html { height: 100%; width: 100%; overflow: hidden; background: #fff; }

    /* éšè—æ‰€æœ‰å±‚ï¼Œé€šè¿‡JSæ§åˆ¶æ˜¾ç¤º */
    .layer { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    
    /* === 1. é…ç½®å±‚æ ·å¼ (ä½ è‡ªå·±çœ‹) === */
    #layer-config { background: #f5f5f5; padding: 20px; overflow-y: auto; z-index: 999; display: block; }
    .cfg-group { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .cfg-label { display: block; font-size: 14px; font-weight: bold; color: #555; margin-bottom: 8px; }
    .cfg-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .btn-start { width: 100%; padding: 15px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }
    .warning-box { background: #fffbe6; border: 1px solid #ffe58f; padding: 10px; font-size: 12px; color: #d48806; margin-bottom: 15px; border-radius: 4px; line-height: 1.5; }

    /* === 2. å‡äºŒç»´ç å±•ç¤ºå±‚ (ä»¿å¾®ä¿¡UIï¼Œç»™è§‚ä¼—çœ‹) === */
    #layer-display { background: #fff; flex-direction: column; z-index: 100; }
    .nav { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; margin-top: env(safe-area-inset-top); }
    .icon-back { width: 12px; height: 12px; border-left: 2px solid #000; border-bottom: 2px solid #000; transform: rotate(45deg); }
    .icon-more { width: 24px; height: 24px; background-image: radial-gradient(circle, #000 2px, transparent 0); background-size: 8px 100%; }
    
    .card-info { padding: 30px 40px 10px; display: flex; align-items: center; gap: 20px; }
    .card-avatar { width: 64px; height: 64px; border-radius: 6px; background: #eee center/cover; flex-shrink: 0; }
    .card-text h2 { font-size: 22px; font-weight: 600; color: #000; margin-bottom: 5px; }
    .card-text p { font-size: 14px; color: #7f7f7f; }

    .qr-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 80px; }
    .qr-frame { width: 280px; height: 280px; position: relative; }
    .wx-center-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 44px; height: 44px; background: #fff; border-radius: 6px; border: 4px solid #fff; display: flex; justify-content: center; align-items: center; }
    .tips { margin-top: 25px; color: #b2b2b2; font-size: 14px; letter-spacing: 0.5px; }
    
    .bottom-menu { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 50px; padding-bottom: env(safe-area-inset-bottom); }
    .menu-item { color: #576b95; font-size: 14px; font-weight: 500; }

    /* === 3. é­”æœ¯äº’åŠ¨å±‚ (è§‚ä¼—æ‰‹æœºä¸Šæ˜¾ç¤º) === */
    #layer-magic { background: var(--bg-wx); flex-direction: column; overflow: hidden; }
    .magic-nav { height: 44px; background: var(--bg-wx); display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
    .magic-content { padding-top: 10px; }
    .magic-card { background: #fff; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; margin-bottom: 8px; }
    .m-avatar { width: 68px; height: 68px; border-radius: 8px; margin-bottom: 12px; background: #eee center/cover; }
    .m-name { font-size: 22px; font-weight: 600; color: #000; margin-bottom: 6px; }
    .m-id { font-size: 14px; color: #7f7f7f; margin-bottom: 20px; }
    
    .m-sign-box { width: 100%; position: relative; min-height: 24px; display: flex; justify-content: center; }
    .m-sign { color: #7f7f7f; font-size: 14px; max-width: 90%; text-align: center; }
    
    /* æ ¸å¿ƒï¼šçº¢å¿ƒ */
    .heart {
        position: absolute; width: 20px; height: 20px; 
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 1000; font-size: 20px; line-height: 1;
        cursor: move; touch-action: none;
        display: flex; justify-content: center; align-items: center;
    }
    .heart::after { content: "â¤ï¸"; }
    
    .magic-cell { height: 56px; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 1px; font-size: 16px; color: #000; }
    .arrow { color: #b2b2b2; font-family: monospace; font-weight: bold; transform: scaleY(1.5); }
    .magic-btn-area { padding: 25px 20px; }
    .magic-btn { width: 100%; height: 48px; background: var(--green); color: #fff; display: flex; justify-content: center; align-items: center; border-radius: 8px; font-size: 17px; font-weight: 600; }
    
    .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <!-- 1. é…ç½®é¢æ¿ (ä»…åœ¨æ²¡æœ‰URLå‚æ•°æ—¶æ˜¾ç¤º) -->
  <div id="layer-config" class="layer">
    <div style="text-align:center; margin-bottom:20px; font-size:20px; font-weight:bold;">ğŸ› ï¸ å¾®ä¿¡é­”æœ¯æ§åˆ¶å°</div>
    
    <div class="warning-box">
      âš ï¸ <b>é‡è¦æç¤º</b>ï¼š<br>
      å¾®ä¿¡æ‰«ä¸€æ‰«å¿…é¡»è¯†åˆ«ç½‘ç»œé“¾æ¥ã€‚<br>
      è¯·åŠ¡å¿…å°†æ­¤æ–‡ä»¶ä¸Šä¼ åˆ°<b>ç½‘ç«™æœåŠ¡å™¨</b>æˆ– <b>Netlify Drop</b> ä¹‹åå†ä½¿ç”¨ã€‚<br>
      å¦‚æœä½ æ˜¯åœ¨æœ¬åœ°ç›´æ¥åŒå‡»æ‰“å¼€çš„ï¼Œç”Ÿæˆçš„äºŒç»´ç <b>åˆ«äººæ‰«ä¸å¼€</b>ã€‚
    </div>

    <div class="cfg-group">
      <label class="cfg-label">å¤´åƒé“¾æ¥ (å¿…é¡»æ˜¯ç½‘ç»œå›¾ç‰‡URL)</label>
      <input type="text" id="in-avatar" class="cfg-input" value="https://img01.yzcdn.cn/vant/cat.jpeg" placeholder="http://...">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">æ˜µç§°</label>
      <input type="text" id="in-name" class="cfg-input" value="å¾®ä¿¡å›¢é˜Ÿ">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">åœ°åŒº</label>
      <input type="text" id="in-region" class="cfg-input" value="ä¸­å›½ å¹¿å·">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">å¾®ä¿¡å· (å±•ç¤ºç”¨)</label>
      <input type="text" id="in-showid" class="cfg-input" value="WeChatTeam">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">ä¸ªæ€§ç­¾å</label>
      <input type="text" id="in-sign" class="cfg-input" value="è¿æ¥ä¸€ç§ç”Ÿæ´»æ–¹å¼">
    </div>
    <div class="cfg-group" style="border: 1px solid var(--green);">
      <label class="cfg-label" style="color:var(--green)">è·³è½¬ç›®æ ‡ (çœŸå®çš„wxid/å¾®ä¿¡å·)</label>
      <input type="text" id="in-target" class="cfg-input" placeholder="å¿…å¡«ï¼ä¾‹å¦‚ wxid_123456789">
    </div>

    <button class="btn-start" onclick="generateQR()">ç”Ÿæˆå±•ç¤ºç•Œé¢</button>
  </div>

  <!-- 2. äºŒç»´ç å±•ç¤ºé¢æ¿ (ä½ çš„æ‰‹æœºæ˜¾ç¤ºè¿™ä¸ª) -->
  <div id="layer-display" class="layer" style="display:none">
    <div class="nav">
      <div class="icon-back" onclick="location.reload()"></div>
      <div class="icon-more"></div>
    </div>
    <div class="card-info">
      <div class="card-avatar" id="d-avatar"></div>
      <div class="card-text">
        <h2 id="d-name"></h2>
        <p id="d-region"></p>
      </div>
    </div>
    <div class="qr-area">
      <div class="qr-frame">
        <div id="qrcode-box"></div> <!-- äºŒç»´ç ç”Ÿæˆåœ¨è¿™é‡Œ -->
        <div class="wx-center-logo">
          <!-- SVG å¾®ä¿¡å›¾æ ‡ -->
          <svg width="30" height="30" viewBox="0 0 28 28" fill="#191919"><path d="M10.5 17.5c-5.8 0-10.5-3.9-10.5-8.75S4.7 0 10.5 0c5.8 0 10.5 3.9 10.5 8.75 0 1.05-.2 2.05-.6 3L23 15l-3.2-1.6c-1.3.8-2.8 1.3-4.4 1.3h-4.9zM20 18.5c0-3.3-3.1-6-7-6s-7 2.7-7 6c0 3.3 3.1 6 7 6 1.3 0 2.5-.3 3.5-.9L20 26l-1-2.4c2.4-1 4-2.8 4-5.1z"/></svg>
        </div>
      </div>
      <div class="tips">æ‰«ä¸€æ‰«ä¸Šé¢çš„äºŒç»´ç å›¾æ¡ˆï¼ŒåŠ æˆ‘ä¸ºæœ‹å‹ã€‚</div>
    </div>
    <div class="bottom-menu">
      <span class="menu-item">æ‰«ä¸€æ‰«</span>
      <span class="menu-item">æ¢ä¸ªæ ·å¼</span>
      <span class="menu-item">ä¿å­˜å›¾ç‰‡</span>
    </div>
  </div>

  <!-- 3. é­”æœ¯äº’åŠ¨é¢æ¿ (è§‚ä¼—æ‰‹æœºæ‰«ç åæ˜¾ç¤º) -->
  <div id="layer-magic" class="layer" style="display:none">
    <div class="magic-nav">
      <div class="icon-back" onclick="history.back()"></div>
      <div class="icon-more" style="margin-left:auto"></div>
    </div>
    <div class="magic-content">
      <div class="magic-card">
        <div class="m-avatar" id="m-avatar"></div>
        <div class="m-name" id="m-name"></div>
        <div class="m-id" id="m-id"></div>
        <div class="m-sign-box">
          <div class="m-sign" id="m-sign"></div>
          <div class="heart" id="magic-heart"></div>
        </div>
      </div>
      
      <div class="magic-cell">
        <span>æœ‹å‹åœˆ</span>
        <span class="arrow">></span>
      </div>
      <div class="magic-cell">
        <span>æ›´å¤šä¿¡æ¯</span>
        <span class="arrow">></span>
      </div>

      <div class="magic-btn-area">
        <div class="magic-btn">æ·»åŠ åˆ°é€šè®¯å½•</div>
      </div>
    </div>
    <div class="loading-mask" id="loading">
      <div class="spinner"></div>
      <div style="margin-top:15px; font-size:14px; color:#666;">æ­£åœ¨è·³è½¬...</div>
    </div>
  </div>

  <script>
    // === é€»è¾‘å¤„ç†ä¸­å¿ƒ ===
    
    // 1. æ£€æŸ¥URLå‚æ•°
    // å¦‚æœURLé‡Œæœ‰ ?data=... è¯´æ˜æ˜¯è§‚ä¼—æ‰«ç è¿›æ¥çš„ -> æ˜¾ç¤ºé­”æœ¯å±‚
    // å¦‚æœæ²¡æœ‰ -> æ˜¾ç¤ºé…ç½®å±‚
    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');

      if (encodedData) {
        // === è§‚ä¼—æ¨¡å¼ ===
        initMagicMode(encodedData);
      } else {
        // === ä¸»æ’­é…ç½®æ¨¡å¼ ===
        document.getElementById('layer-config').style.display = 'block';
      }
    };

    // ç”ŸæˆäºŒç»´ç å¹¶åˆ‡æ¢åˆ°å±•ç¤ºç•Œé¢
    function generateQR() {
      const config = {
        av: document.getElementById('in-avatar').value,
        nm: document.getElementById('in-name').value,
        rg: document.getElementById('in-region').value,
        id: document.getElementById('in-showid').value,
        sg: document.getElementById('in-sign').value,
        tg: document.getElementById('in-target').value
      };

      if(!config.tg) { alert('è·³è½¬ç›®æ ‡å¿…å¡«ï¼'); return; }

      // 1. æ¸²æŸ“â€œå‡äºŒç»´ç ç•Œé¢â€çš„ä¿¡æ¯
      document.getElementById('d-avatar').style.backgroundImage = `url('${config.av}')`;
      document.getElementById('d-name').textContent = config.nm;
      document.getElementById('d-region').textContent = config.rg;

      // 2. ç”Ÿæˆç»™è§‚ä¼—æ‰«çš„é“¾æ¥
      // æŠŠé…ç½®ä¿¡æ¯è½¬æˆJSONå†Base64ç¼–ç ï¼Œæ‹¼æ¥åˆ°å½“å‰URLåé¢
      const jsonStr = JSON.stringify(config);
      // ä½¿ç”¨ encodeURIComponent ç¡®ä¿ URL å®‰å…¨
      const base64Str = btoa(encodeURIComponent(jsonStr)); 
      
      // è·å–å½“å‰é¡µé¢çš„çº¯å‡€URL (å»æ‰å¯èƒ½å­˜åœ¨çš„å‚æ•°)
      const baseUrl = window.location.href.split('?')[0];
      const magicUrl = `${baseUrl}?data=${base64Str}`;

      // 3. ç”ŸæˆäºŒç»´ç 
      document.getElementById('qrcode-box').innerHTML = '';
      new QRCode(document.getElementById('qrcode-box'), {
        text: magicUrl,
        width: 280,
        height: 280,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.M
      });

      // 4. åˆ‡æ¢æ˜¾ç¤º
      document.getElementById('layer-config').style.display = 'none';
      document.getElementById('layer-display').style.display = 'flex';
    }

    // åˆå§‹åŒ–é­”æœ¯æ¨¡å¼ (è§‚ä¼—ç«¯)
    function initMagicMode(encodedData) {
      try {
        // è§£ç æ•°æ®
        // å¯¹åº”ä¸Šé¢çš„ç¼–ç è¿‡ç¨‹: atob -> decodeURIComponent -> JSON.parse
        const jsonStr = decodeURIComponent(atob(encodedData));
        const config = JSON.parse(jsonStr);

        // æ¸²æŸ“é­”æœ¯ç•Œé¢
        document.getElementById('m-avatar').style.backgroundImage = `url('${config.av}')`;
        document.getElementById('m-name').textContent = config.nm;
        document.getElementById('m-id').textContent = `å¾®ä¿¡å·ï¼š${config.id}`;
        document.getElementById('m-sign').textContent = config.sg;
        
        document.title = "è¯¦ç»†èµ„æ–™"; // ä¼ªè£…æ ‡é¢˜
        document.getElementById('layer-magic').style.display = 'flex';

        // åˆå§‹åŒ–ç‰©ç†å¼•æ“
        initPhysics(config.tg);

      } catch (e) {
        alert('æ•°æ®è§£æé”™è¯¯ï¼Œè¯·é‡æ–°ç”Ÿæˆ');
        console.error(e);
      }
    }

    // ç‰©ç†å¼•æ“ & è·³è½¬é€»è¾‘
    function initPhysics(targetWxId) {
      const heart = document.getElementById('magic-heart');
      const loading = document.getElementById('loading');
      let isDragging = false;

      // ç‚¹å‡»å˜å¤§
      heart.addEventListener('click', (e) => {
        e.stopPropagation();
        let size = parseInt(window.getComputedStyle(heart).fontSize);
        if(size < 80) {
          size += 10;
          heart.style.width = size + 'px';
          heart.style.height = size + 'px';
          heart.style.fontSize = size + 'px';
        }
      });

      // è§¦æ‘¸å¼€å§‹
      heart.addEventListener('touchstart', (e) => {
        isDragging = true;
        const rect = heart.getBoundingClientRect();
        // åˆ‡æ¢åˆ° fixed å®šä½ï¼Œæ–¹ä¾¿å…¨å±æ‹–æ‹½
        heart.style.position = 'fixed';
        heart.style.left = (rect.left + rect.width/2) + 'px';
        heart.style.top = (rect.top + rect.height/2) + 'px';
        heart.style.margin = 0;
      }, {passive: false});

      // è§¦æ‘¸ç§»åŠ¨
      heart.addEventListener('touchmove', (e) => {
        if(!isDragging) return;
        e.preventDefault(); // ç¦æ­¢é¡µé¢æ»šåŠ¨
        const touch = e.touches[0];
        heart.style.left = touch.clientX + 'px';
        heart.style.top = touch.clientY + 'px';
      }, {passive: false});

      // è§¦æ‘¸ç»“æŸ
      heart.addEventListener('touchend', (e) => {
        if(!isDragging) return;
        isDragging = false;

        const rect = heart.getBoundingClientRect();
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        // åˆ¤æ–­æ˜¯å¦æ‹–åˆ°è¾¹ç¼˜ (è·ç¦»è¾¹ç¼˜å°äº20px)
        const x = rect.left + rect.width/2;
        const y = rect.top + rect.height/2;
        
        if(x < 30 || x > winW - 30 || y < 30 || y > winH - 30) {
          // è§¦å‘é­”æœ¯
          heart.style.display = 'none';
          loading.style.display = 'flex';
          
          setTimeout(() => {
            // è·³è½¬åè®®
            window.location.href = `weixin://contacts/profile/${targetWxId}`;
            
            // å…œåº•æç¤º (ä¸‡ä¸€è·³è½¬å¤±è´¥)
            setTimeout(() => {
              loading.style.display = 'none';
            }, 2000);
          }, 600);
        } else {
          // å¤ä½æ•ˆæœ (å¦‚æœæ²¡æ‹–å‡ºå»)
          heart.style.transition = 'all 0.3s ease';
          // ç®€å•å¤ä½åˆ°å±å¹•ä¸­å¿ƒé™„è¿‘ï¼Œæˆ–è€…è¿™é‡Œå¯ä»¥å†™å¾—æ›´å¤æ‚å›åˆ°åŸä½
          // æ—¢ç„¶æ˜¯ fixed äº†ï¼Œç›´æ¥å›åˆ° signature åŒºåŸŸæ¯”è¾ƒéº»çƒ¦ï¼Œ
          // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šç›´æ¥è®©å®ƒç¨å¾®å¼¹ä¸€ä¸‹ï¼Œç•™åœ¨åŸåœ°ï¼Œæ–¹ä¾¿ç»§ç»­æ‹–
          setTimeout(() => { heart.style.transition = ''; }, 300);
        }
      });
    }
  </script>
</body>
</html>