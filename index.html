<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>微信魔术交互工具</title>
  <!-- 引入稳定的二维码库 -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <style>
    /* 基础样式重置 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .page { display: none; min-height: 100vh; }
    .btn { cursor: pointer; }
    .hidden { display: none !important; }

    /* 1. 设置端页面样式 */
    #setup-page { background-color: #f5f5f5; padding: 20px; }
    .setup-title { text-align: center; font-size: 22px; font-weight: 600; margin: 20px 0; color: #333; }
    .setup-desc { background-color: #fff8e1; border: 1px solid #ffe082; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 13px; color: #ff8f00; line-height: 1.5; }
    .form-group { background-color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .form-label { display: block; font-size: 14px; color: #555; margin-bottom: 8px; }
    .form-input { width: 100%; padding: 12px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; transition: border-color 0.2s; }
    .form-input:focus { border-color: #07c160; outline: none; }
    .form-input.required { border: 1px solid #07c160; }
    .form-label.required { color: #07c160; font-weight: 500; }
    .generate-btn { width: 100%; padding: 15px; background-color: #07c160; color: #fff; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; margin-top: 10px; transition: background-color 0.2s; }
    .generate-btn:hover { background-color: #06b054; }

    /* 2. 二维码展示页（设置端给观众扫） */
    #qrcode-page { background-color: #fff; position: relative; }
    .nav-bar { height: 44px; display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid #eee; }
    .back-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
    .back-icon { width: 12px; height: 12px; border-left: 2px solid #000; border-bottom: 2px solid #000; transform: rotate(45deg); }
    .user-card { padding: 25px 20px; display: flex; align-items: center; gap: 15px; }
    .avatar-img { width: 64px; height: 64px; border-radius: 8px; background-color: #eee; background-size: cover; background-position: center; }
    .user-info { flex: 1; }
    .user-name { font-size: 20px; font-weight: 600; color: #000; }
    .user-region { font-size: 14px; color: #888; margin-top: 4px; }
    .qrcode-container { display: flex; flex-direction: column; align-items: center; margin-top: 30px; }
    .qrcode-wrapper { width: 280px; height: 280px; background-color: #fff; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-radius: 4px; }
    .qrcode-img { width: 100%; height: 100%; }
    .qrcode-tip { margin-top: 25px; font-size: 14px; color: #999; letter-spacing: 0.5px; }
    .qrcode-footer { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 50px; color: #576b95; font-size: 14px; }

    /* 3. 观众端假界面（黑色背景） */
    #viewer-page { background-color: #1a1a1a; color: #fff; position: relative; }
    .viewer-nav { height: 44px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .viewer-nav .back-icon { border-color: #fff; }
    .viewer-header { padding: 15px; display: flex; align-items: center; gap: 15px; }
    .viewer-avatar { width: 60px; height: 60px; border-radius: 8px; background-color: #eee; background-size: cover; background-position: center; }
    .viewer-name { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
    .verify-badge { width: 16px; height: 16px; background: url('https://img.icons8.com/fluency/48/00b4ff/verified-account.png') center/cover; }
    .viewer-region { font-size: 14px; color: #8e8e93; margin-top: 3px; }
    .info-list { margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); }
    .info-item { height: 50px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .item-label { font-size: 16px; color: #8e8e93; width: 80px; }
    .item-content { flex: 1; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
    .item-arrow { color: #8e8e93; font-family: monospace; font-size: 18px; }
    .sign-container { position: relative; width: 100%; padding-right: 30px; /* 预留红心位置 */ }
    .sign-text { width: 100%; word-break: break-all; }
    .heart-icon { position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 20px; cursor: move; touch-action: none; transition: transform 0.1s ease; z-index: 100; }
    .add-contact-btn { margin: 20px 15px; height: 45px; background-color: #333; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 17px; color: #8e8e93; }
    .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(26,26,26,0.9); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
    .loading-spinner { width: 30px; height: 30px; border: 3px solid #444; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { margin-top: 15px; font-size: 14px; color: #ccc; }
    .error-toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.8); color: #fff; padding: 12px 20px; border-radius: 4px; font-size: 14px; z-index: 1000; display: none; }
  </style>
</head>
<body>
  <!-- 1. 设置端页面（仅配置者可见） -->
  <div id="setup-page" class="page">
    <div class="setup-title">微信魔术配置面板</div>
    <div class="setup-desc">
      ⚠️ 请先将文件部署到HTTPS服务器（如Vercel/Netlify），微信仅支持HTTPS扫码。<br>
      流程：填写信息 → 生成假二维码 → 观众扫码 → 触发红心交互 → 跳转真实添加界面
    </div>
    
    <div class="form-group">
      <label class="form-label">头像链接（网络图片URL）</label>
      <input type="text" id="avatar" class="form-input" value="https://picsum.photos/200/200" placeholder="例如：https://xxx.com/avatar.jpg">
    </div>
    
    <div class="form-group">
      <label class="form-label">昵称</label>
      <input type="text" id="name" class="form-input" value="冯唐骏" placeholder="设置显示的昵称">
    </div>
    
    <div class="form-group">
      <label class="form-label">地区</label>
      <input type="text" id="region" class="form-input" value="浙江 杭州" placeholder="例如：北京 朝阳">
    </div>
    
    <div class="form-group">
      <label class="form-label">个性签名</label>
      <input type="text" id="sign" class="form-input" value="我爱果汁，我爱果汁，我爱果汁" placeholder="显示在签名栏的内容">
    </div>
    
    <div class="form-group">
      <label class="form-label required">真实微信号/ID（必填）</label>
      <input type="text" id="realWxId" class="form-input required" placeholder="例如：wxid_123456789（观众最终会跳转这里）">
    </div>
    
    <button class="generate-btn btn" onclick="generateQRCode()">生成假二维码界面</button>
  </div>

  <!-- 2. 二维码展示页（配置者展示给观众扫） -->
  <div id="qrcode-page" class="page">
    <div class="nav-bar">
      <div class="back-btn btn" onclick="switchPage('setup-page')">
        <div class="back-icon"></div>
      </div>
    </div>
    
    <div class="user-card">
      <div class="avatar-img" id="qrcode-avatar"></div>
      <div class="user-info">
        <div class="user-name" id="qrcode-name"></div>
        <div class="user-region" id="qrcode-region"></div>
      </div>
    </div>
    
    <div class="qrcode-container">
      <div class="qrcode-wrapper">
        <div class="qrcode-img" id="qrcode-img"></div>
      </div>
      <div class="qrcode-tip">扫一扫上面的二维码图案，加我为朋友</div>
    </div>
    
    <div class="qrcode-footer">
      <div>扫一扫</div>
      <div>换个样式</div>
      <div>保存图片</div>
    </div>
  </div>

  <!-- 3. 观众端假界面（黑色背景带红心交互） -->
  <div id="viewer-page" class="page">
    <div class="viewer-nav">
      <div class="back-btn btn" onclick="history.back()">
        <div class="back-icon"></div>
      </div>
    </div>
    
    <div class="viewer-header">
      <div class="viewer-avatar" id="viewer-avatar"></div>
      <div>
        <div class="viewer-name" id="viewer-name">
          冯唐骏 <div class="verify-badge"></div>
        </div>
        <div class="viewer-region" id="viewer-region">地区: 浙江 杭州</div>
      </div>
    </div>
    
    <div class="info-list">
      <div class="info-item">
        <div class="item-label">朋友资料</div>
        <div class="item-content">
          <span></span>
          <span class="item-arrow">></span>
        </div>
      </div>
      
      <div class="info-item">
        <div class="item-label">签名</div>
        <div class="item-content">
          <div class="sign-container">
            <div class="sign-text" id="viewer-sign">我爱果汁，我爱果汁，我爱果汁</div>
            <div class="heart-icon" id="heart-icon">❤️</div>
          </div>
          <span class="item-arrow">></span>
        </div>
      </div>
      
      <div class="info-item">
        <div class="item-label">朋友圈</div>
        <div class="item-content">
          <span></span>
          <span class="item-arrow">></span>
        </div>
      </div>
      
      <div class="info-item">
        <div class="item-label">视频号</div>
        <div class="item-content">
          <span id="viewer-video">冯唐骏</span>
          <span class="item-arrow">></span>
        </div>
      </div>
    </div>
    
    <div class="add-contact-btn">添加到通讯录</div>
    
    <div class="loading-mask" id="loading-mask">
      <div class="loading-spinner"></div>
      <div class="loading-text">正在跳转微信...</div>
    </div>
    
    <div class="error-toast" id="error-toast">参数错误，请重新生成二维码</div>
  </div>

  <script>
    // 页面切换工具函数
    function switchPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.style.display = 'none';
      });
      document.getElementById(pageId).style.display = 'block';
    }

    // 【核心优化1：参数编码升级】使用base64url编码（兼容URL特殊字符）
    function encodeData(data) {
      return btoa(unescape(encodeURIComponent(JSON.stringify(data))))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, ''); // 去除填充字符=，避免URL解析问题
    }

    function decodeData(encoded) {
      // 还原base64url为标准base64
      encoded = encoded.replace(/-/g, '+').replace(/_/g, '/');
      // 补全填充字符=
      while (encoded.length % 4 !== 0) encoded += '=';
      return JSON.parse(decodeURIComponent(escape(atob(encoded))));
    }

    // 生成假二维码（设置端核心逻辑）
    function generateQRCode() {
      // 1. 获取并验证配置信息
      const config = {
        avatar: document.getElementById('avatar').value.trim() || 'https://picsum.photos/200/200',
        name: document.getElementById('name').value.trim() || '微信用户',
        region: document.getElementById('region').value.trim() || '未知地区',
        sign: document.getElementById('sign').value.trim() || '暂无签名',
        realWxId: document.getElementById('realWxId').value.trim()
      };

      // 严格验证必填项
      if (!config.realWxId) {
        alert('请填写真实微信号/ID（这是跳转的关键）');
        document.getElementById('realWxId').focus();
        return;
      }

      // 2. 渲染二维码页的用户信息
      document.getElementById('qrcode-avatar').style.backgroundImage = `url('${config.avatar}')`;
      document.getElementById('qrcode-name').textContent = config.name;
      document.getElementById('qrcode-region').textContent = config.region;

      // 3. 生成带唯一标识的观众端链接
      // 【核心优化2：强制绝对路径+唯一角色参数】
      const baseUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`;
      const encodedConfig = encodeData(config);
      // 用role=viewer作为观众端唯一标识，避免与其他参数冲突
      const viewerUrl = `${baseUrl}?role=viewer&data=${encodedConfig}`;

      // 4. 生成二维码（使用高容错级别）
      const qrcodeElement = document.getElementById('qrcode-img');
      qrcodeElement.innerHTML = ''; // 清空旧二维码
      new QRCode(qrcodeElement, {
        text: viewerUrl,
        width: 260,
        height: 260,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H // 最高容错级别，避免扫码失败
      });

      // 5. 切换到二维码展示页
      switchPage('qrcode-page');
    }

    // 【核心优化3：页面身份识别强化】
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const role = params.get('role');
      const data = params.get('data');

      // 观众端：必须同时满足role=viewer和有data参数
      if (role === 'viewer' && data) {
        try {
          const config = decodeData(data);
          renderViewerPage(config); // 渲染观众假界面
        } catch (e) {
          // 解析失败时显示错误提示（而非跳设置页）
          switchPage('setup-page');
          document.getElementById('error-toast').style.display = 'block';
          setTimeout(() => {
            document.getElementById('error-toast').style.display = 'none';
          }, 3000);
          console.error('参数解析失败:', e);
        }
      } else {
        // 非观众端（无role=viewer参数）：显示设置页
        switchPage('setup-page');
      }
    };

    // 渲染观众端假界面
    function renderViewerPage(config) {
      // 填充配置信息到界面
      document.getElementById('viewer-avatar').style.backgroundImage = `url('${config.avatar}')`;
      document.getElementById('viewer-name').innerHTML = `${config.name} <div class="verify-badge"></div>`;
      document.getElementById('viewer-region').textContent = `地区: ${config.region}`;
      document.getElementById('viewer-sign').textContent = config.sign;
      document.getElementById('viewer-video').textContent = config.name;

      // 显示观众界面
      switchPage('viewer-page');

      // 初始化红心交互
      initHeartInteraction(config.realWxId);
    }

    // 【核心优化4：红心交互体验升级】
    function initHeartInteraction(realWxId) {
      const heart = document.getElementById('heart-icon');
      const loading = document.getElementById('loading-mask');
      let isDragging = false;
      let startX = 0, startY = 0;
      const originalSize = 20; // 初始大小
      let currentSize = originalSize;

      // 点击放大（限制最大尺寸）
      heart.addEventListener('click', () => {
        if (currentSize < 100) {
          currentSize += 15;
          heart.style.fontSize = `${currentSize}px`;
        }
      });

      // 触摸开始：记录初始位置
      heart.addEventListener('touchstart', (e) => {
        isDragging = true;
        const touch = e.touches[0];
        const rect = heart.getBoundingClientRect();
        // 计算触摸点相对于红心左上角的偏移量（避免拖拽时跳动）
        startX = touch.clientX - rect.left;
        startY = touch.clientY - rect.top;
        // 切换为fixed定位，确保全屏可拖拽
        heart.style.position = 'fixed';
        heart.style.zIndex = '999';
      }, { passive: true });

      // 触摸移动：平滑跟随手指
      heart.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        const touch = e.touches[0];
        // 根据偏移量计算新位置，确保红心中心点跟随手指
        heart.style.left = `${touch.clientX - startX}px`;
        heart.style.top = `${touch.clientY - startY}px`;
      }, { passive: true });

      // 触摸结束：判断是否拖出屏幕
      heart.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;

        const rect = heart.getBoundingClientRect();
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;

        // 拖出屏幕边界的判断（增加10px缓冲，避免误判）
        const isOutOfScreen = 
          rect.left < -10 || 
          rect.right > winWidth + 10 || 
          rect.top < -10 || 
          rect.bottom > winHeight + 10;

        if (isOutOfScreen) {
          // 拖出屏幕：隐藏红心并显示加载动画
          heart.style.opacity = '0';
          loading.style.display = 'flex';

          // 延迟跳转（模拟加载体验）
          setTimeout(() => {
            // 微信原生添加好友协议（兼容所有版本）
            window.location.href = `weixin://contacts/profile/${realWxId}`;
            // 2秒后关闭加载层（无论跳转是否成功）
            setTimeout(() => {
              loading.style.display = 'none';
            }, 2000);
          }, 600);
        } else {
          // 未拖出屏幕：平滑复位
          heart.style.transition = 'all 0.3s ease-out';
          heart.style.position = 'absolute';
          heart.style.left = 'auto';
          heart.style.right = '0';
          heart.style.top = '50%';
          heart.style.transform = 'translateY(-50%)';
          heart.style.fontSize = `${originalSize}px`;
          currentSize = originalSize;

          // 清除过渡效果
          setTimeout(() => {
            heart.style.transition = '';
          }, 300);
        }
      });
    }
  </script>
</body>
</html>