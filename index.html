<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>å¾®ä¿¡é­”æœ¯åç‰‡</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --bg-wx: #ededed; --green: #07c160; --dark: #191919; }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
    body, html { height: 100%; width: 100%; overflow: hidden; background: #fff; }

    /* éšè—æ‰€æœ‰å±‚ï¼Œé€šè¿‡JSæ§åˆ¶æ˜¾ç¤º */
    .layer { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
    
    /* === 1. é…ç½®å±‚æ ·å¼ === */
    #layer-config { background: #f5f5f5; padding: 20px; overflow-y: auto; z-index: 999; display: block; }
    .cfg-group { background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .cfg-label { display: block; font-size: 14px; font-weight: bold; color: #555; margin-bottom: 8px; }
    .cfg-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    .btn-start { width: 100%; padding: 15px; background: var(--green); color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; }
    .warning-box { background: #fffbe6; border: 1px solid #ffe58f; padding: 10px; font-size: 12px; color: #d48806; margin-bottom: 15px; border-radius: 4px; line-height: 1.5; }

    /* === 2. å‡äºŒç»´ç å±•ç¤ºå±‚ (ä»¿å¾®ä¿¡UI) === */
    #layer-display { background: #fff; flex-direction: column; z-index: 100; }
    .nav { height: 44px; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; margin-top: env(safe-area-inset-top); }
    .icon-back { width: 12px; height: 12px; border-left: 2px solid #000; border-bottom: 2px solid #000; transform: rotate(45deg); }
    .icon-more { width: 24px; height: 24px; background-image: radial-gradient(circle, #000 2px, transparent 0); background-size: 8px 100%; }
    
    .card-info { padding: 30px 40px 10px; display: flex; align-items: center; gap: 20px; }
    .card-avatar { width: 64px; height: 64px; border-radius: 6px; background: #eee center/cover; flex-shrink: 0; }
    .card-text h2 { font-size: 22px; font-weight: 600; color: #000; margin-bottom: 5px; }
    .card-text p { font-size: 14px; color: #7f7f7f; }

    .qr-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding-bottom: 80px; }
    .qr-frame { width: 280px; height: 280px; position: relative; }
    .wx-center-logo { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 44px; height: 44px; background: #fff; border-radius: 6px; border: 4px solid #fff; display: flex; justify-content: center; align-items: center; }
    .tips { margin-top: 25px; color: #b2b2b2; font-size: 14px; letter-spacing: 0.5px; }
    
    .bottom-menu { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 50px; padding-bottom: env(safe-area-inset-bottom); }
    .menu-item { color: #576b95; font-size: 14px; font-weight: 500; }

    /* === 3. é­”æœ¯äº’åŠ¨å±‚ (è§‚ä¼—ç«¯è™šå‡ä¸ªäººä¿¡æ¯ç•Œé¢) === */
    #layer-magic { background: var(--bg-wx); flex-direction: column; overflow: hidden; }
    .magic-nav { height: 44px; background: var(--bg-wx); display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid rgba(0,0,0,0.1); }
    .magic-content { padding-top: 10px; }
    .magic-card { background: #fff; padding: 30px 20px; display: flex; flex-direction: column; align-items: center; margin-bottom: 8px; }
    .m-avatar { width: 68px; height: 68px; border-radius: 8px; margin-bottom: 12px; background: #eee center/cover; }
    .m-name { font-size: 22px; font-weight: 600; color: #000; margin-bottom: 6px; }
    .m-id { font-size: 14px; color: #7f7f7f; margin-bottom: 20px; }
    
    .m-sign-box { width: 100%; position: relative; min-height: 24px; display: flex; justify-content: center; }
    .m-sign { color: #7f7f7f; font-size: 14px; max-width: 90%; text-align: center; }
    
    /* æ ¸å¿ƒï¼šçº¢å¿ƒäº¤äº’å…ƒç´  */
    .heart {
        position: absolute; width: 20px; height: 20px; 
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        z-index: 1000; font-size: 20px; line-height: 1;
        cursor: move; touch-action: none;
        display: flex; justify-content: center; align-items: center;
    }
    .heart::after { content: "â¤ï¸"; }
    
    .magic-cell { height: 56px; background: #fff; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; margin-bottom: 1px; font-size: 16px; color: #000; }
    .arrow { color: #b2b2b2; font-family: monospace; font-weight: bold; transform: scaleY(1.5); }
    .magic-btn-area { padding: 25px 20px; }
    .magic-btn { width: 100%; height: 48px; background: var(--green); color: #fff; display: flex; justify-content: center; align-items: center; border-radius: 8px; font-size: 17px; font-weight: 600; }
    
    .loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .spinner { width: 30px; height: 30px; border: 3px solid #ddd; border-top-color: #333; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>
<body>

  <!-- 1. é…ç½®é¢æ¿ -->
  <div id="layer-config" class="layer">
    <div style="text-align:center; margin-bottom:20px; font-size:20px; font-weight:bold;">ğŸ› ï¸ å¾®ä¿¡é­”æœ¯æ§åˆ¶å°</div>
    
    <div class="warning-box">
      âš ï¸ <b>é‡è¦æç¤º</b>ï¼š<br>
      è¯·å°†æ–‡ä»¶ä¸Šä¼ åˆ°<b>HTTPSæœåŠ¡å™¨</b>ï¼ˆå¦‚Netlify/Vercelï¼‰ï¼Œå¾®ä¿¡ä»…æ”¯æŒHTTPSé“¾æ¥æ‰«ç ã€‚<br>
      æœ¬åœ°æ‰“å¼€äºŒç»´ç ä¼šæ— æ³•æ‰«æï¼
    </div>

    <div class="cfg-group">
      <label class="cfg-label">å¤´åƒé“¾æ¥ (ç½‘ç»œå›¾ç‰‡URL)</label>
      <input type="text" id="in-avatar" class="cfg-input" value="https://img01.yzcdn.cn/vant/cat.jpeg" placeholder="https://...">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">æ˜µç§°</label>
      <input type="text" id="in-name" class="cfg-input" value="èƒ–è™æ²¡æˆ‘èƒ–">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">åœ°åŒº</label>
      <input type="text" id="in-region" class="cfg-input" value="æµ™æ±Ÿ å°å·">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">å¾®ä¿¡å· (å±•ç¤ºç”¨)</label>
      <input type="text" id="in-showid" class="cfg-input" value="PangHu666">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">ä¸ªæ€§ç­¾å</label>
      <input type="text" id="in-sign" class="cfg-input" value="ä»Šæ—¥ä»½å¯çˆ±å·²é€è¾¾">
    </div>
    <div class="cfg-group" style="border: 1px solid var(--green);">
      <label class="cfg-label" style="color:var(--green)">çœŸå®å¾®ä¿¡å·/ID (å¿…å¡«)</label>
      <input type="text" id="in-target" class="cfg-input" placeholder="ä¾‹å¦‚ï¼šwxid_123456789 æˆ– PangHu666">
    </div>

    <button class="btn-start" onclick="generateQR()">ç”Ÿæˆé­”æœ¯äºŒç»´ç </button>
  </div>

  <!-- 2. å‡äºŒç»´ç å±•ç¤ºå±‚ (ä½ çš„æ‰‹æœºæ˜¾ç¤º) -->
  <div id="layer-display" class="layer" style="display:none">
    <div class="nav">
      <div class="icon-back" onclick="location.reload()"></div>
      <div class="icon-more"></div>
    </div>
    <div class="card-info">
      <div class="card-avatar" id="d-avatar"></div>
      <div class="card-text">
        <h2 id="d-name"></h2>
        <p id="d-region"></p>
      </div>
    </div>
    <div class="qr-area">
      <div class="qr-frame">
        <div id="qrcode-box"></div>
        <div class="wx-center-logo">
          <svg width="30" height="30" viewBox="0 0 28 28" fill="#191919"><path d="M10.5 17.5c-5.8 0-10.5-3.9-10.5-8.75S4.7 0 10.5 0c5.8 0 10.5 3.9 10.5 8.75 0 1.05-.2 2.05-.6 3L23 15l-3.2-1.6c-1.3.8-2.8 1.3-4.4 1.3h-4.9zM20 18.5c0-3.3-3.1-6-7-6s-7 2.7-7 6c0 3.3 3.1 6 7 6 1.3 0 2.5-.3 3.5-.9L20 26l-1-2.4c2.4-1 4-2.8 4-5.1z"/></svg>
        </div>
      </div>
      <div class="tips">æ‰«ä¸€æ‰«ä¸Šé¢çš„äºŒç»´ç å›¾æ¡ˆï¼ŒåŠ æˆ‘ä¸ºæœ‹å‹ã€‚</div>
    </div>
    <div class="bottom-menu">
      <span class="menu-item">æ‰«ä¸€æ‰«</span>
      <span class="menu-item">æ¢ä¸ªæ ·å¼</span>
      <span class="menu-item">ä¿å­˜å›¾ç‰‡</span>
    </div>
  </div>

  <!-- 3. é­”æœ¯äº’åŠ¨å±‚ (è§‚ä¼—æ‰«ç åæ˜¾ç¤ºçš„è™šå‡ç•Œé¢) -->
  <div id="layer-magic" class="layer" style="display:none">
    <div class="magic-nav">
      <div class="icon-back" onclick="history.back()"></div>
      <div class="icon-more" style="margin-left:auto"></div>
    </div>
    <div class="magic-content">
      <div class="magic-card">
        <div class="m-avatar" id="m-avatar"></div>
        <div class="m-name" id="m-name"></div>
        <div class="m-id" id="m-id"></div>
        <div class="m-sign-box">
          <div class="m-sign" id="m-sign"></div>
          <div class="heart" id="magic-heart"></div>
        </div>
      </div>
      
      <div class="magic-cell">
        <span>æœ‹å‹åœˆ</span>
        <span class="arrow">></span>
      </div>
      <div class="magic-cell">
        <span>æ›´å¤šä¿¡æ¯</span>
        <span class="arrow">></span>
      </div>

      <div class="magic-btn-area">
        <div class="magic-btn">æ·»åŠ åˆ°é€šè®¯å½•</div>
      </div>
    </div>
    <div class="loading-mask" id="loading">
      <div class="spinner"></div>
      <div style="margin-top:15px; font-size:14px; color:#666;">æ­£åœ¨è·³è½¬...</div>
    </div>
  </div>

  <script>
    // === æ ¸å¿ƒé€»è¾‘ä¼˜åŒ– ===
    window.onload = function() {
      const urlParams = new URLSearchParams(window.location.search);
      const encodedData = urlParams.get('data');
      if (encodedData) initMagicMode(encodedData);
      else document.getElementById('layer-config').style.display = 'block';
    };

    // ç”Ÿæˆé­”æœ¯äºŒç»´ç ï¼ˆä¿®å¤URLç¼–ç +HTTPSé€‚é…ï¼‰
    function generateQR() {
      const config = {
        av: document.getElementById('in-avatar').value,
        nm: document.getElementById('in-name').value,
        rg: document.getElementById('in-region').value,
        id: document.getElementById('in-showid').value,
        sg: document.getElementById('in-sign').value,
        tg: document.getElementById('in-target').value
      };

      if(!config.tg) { alert('è¯·å¡«å†™çœŸå®å¾®ä¿¡å·/IDï¼'); return; }

      // æ¸²æŸ“å‡äºŒç»´ç ç•Œé¢
      document.getElementById('d-avatar').style.backgroundImage = `url('${config.av}')`;
      document.getElementById('d-name').textContent = config.nm;
      document.getElementById('d-region').textContent = config.rg;

      // ä¿®å¤ï¼šç”¨URLå®‰å…¨çš„Base64ç¼–ç ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
      const jsonStr = JSON.stringify(config);
      const base64Str = btoa(unescape(encodeURIComponent(jsonStr))); 
      const baseUrl = window.location.href.split('?')[0];
      const magicUrl = `${baseUrl}?data=${base64Str}`;

      // ç”Ÿæˆé«˜å®¹é”™ç‡äºŒç»´ç 
      document.getElementById('qrcode-box').innerHTML = '';
      new QRCode(document.getElementById('qrcode-box'), {
        text: magicUrl,
        width: 280,
        height: 280,
        colorDark: "#000",
        colorLight: "#fff",
        correctLevel: QRCode.CorrectLevel.H // æé«˜æ‰«ç æˆåŠŸç‡
      });

      // åˆ‡æ¢æ˜¾ç¤º
      document.getElementById('layer-config').style.display = 'none';
      document.getElementById('layer-display').style.display = 'flex';
    }

    // è§‚ä¼—ç«¯è™šå‡ç•Œé¢åˆå§‹åŒ–
    function initMagicMode(encodedData) {
      try {
        // ä¿®å¤ï¼šå¯¹åº”å®‰å…¨ç¼–ç çš„è§£ç é€»è¾‘
        const jsonStr = decodeURIComponent(escape(atob(encodedData)));
        const config = JSON.parse(jsonStr);

        // æ¸²æŸ“è™šå‡ä¸ªäººä¿¡æ¯
        document.getElementById('m-avatar').style.backgroundImage = `url('${config.av}')`;
        document.getElementById('m-name').textContent = config.nm;
        document.getElementById('m-id').textContent = `å¾®ä¿¡å·ï¼š${config.id}`;
        document.getElementById('m-sign').textContent = config.sg;
        document.title = "è¯¦ç»†èµ„æ–™";
        document.getElementById('layer-magic').style.display = 'flex';

        // åˆå§‹åŒ–çº¢å¿ƒäº¤äº’+è·³è½¬é€»è¾‘
        initHeartInteraction(config.tg);

      } catch (e) {
        alert('æ•°æ®è§£æå¤±è´¥ï¼Œè¯·é‡æ–°ç”ŸæˆäºŒç»´ç ');
        console.error(e);
      }
    }

    // ä¿®å¤ï¼šçº¢å¿ƒäº¤äº’+è·³è½¬é€»è¾‘ï¼ˆè§£å†³è·³è½¬æ— å“åº”ï¼‰
    function initHeartInteraction(targetWxId) {
      const heart = document.getElementById('magic-heart');
      const loading = document.getElementById('loading');
      let isDragging = false;
      const originPos = { // è®°å½•çº¢å¿ƒåŸå§‹ä½ç½®ï¼Œç”¨äºå¤ä½
        top: heart.style.top,
        left: heart.style.left,
        size: 20
      };

      // ç‚¹å‡»å˜å¤§
      heart.addEventListener('click', (e) => {
        e.stopPropagation();
        let size = parseInt(window.getComputedStyle(heart).fontSize);
        if(size < 100) { // æ”¾å¤§ä¸Šé™æé«˜åˆ°100ï¼Œäº¤äº’æ›´æ˜æ˜¾
          size += 15;
          heart.style.width = size + 'px';
          heart.style.height = size + 'px';
          heart.style.fontSize = size + 'px';
        }
      });

      // è§¦æ‘¸å¼€å§‹
      heart.addEventListener('touchstart', (e) => {
        isDragging = true;
        const rect = heart.getBoundingClientRect();
        heart.style.position = 'fixed';
        heart.style.left = (rect.left + rect.width/2) + 'px';
        heart.style.top = (rect.top + rect.height/2) + 'px';
        heart.style.margin = 0;
      }, {passive: false});

      // è§¦æ‘¸ç§»åŠ¨
      heart.addEventListener('touchmove', (e) => {
        if(!isDragging) return;
        e.preventDefault();
        const touch = e.touches[0];
        heart.style.left = touch.clientX + 'px';
        heart.style.top = touch.clientY + 'px';
      }, {passive: false});

      // è§¦æ‘¸ç»“æŸï¼ˆä¿®å¤è·³è½¬é€»è¾‘ï¼‰
      heart.addEventListener('touchend', (e) => {
        if(!isDragging) return;
        isDragging = false;

        const rect = heart.getBoundingClientRect();
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        // åˆ¤æ–­æ˜¯å¦æ‹–å‡ºå±å¹•
        const isOutOfScreen = rect.left < 0 || rect.right > winW || rect.top < 0 || rect.bottom > winH;
        
        if(isOutOfScreen) {
          // è§¦å‘é­”æœ¯ï¼šéšè—çº¢å¿ƒ+æ˜¾ç¤ºåŠ è½½+è·³è½¬çœŸå®æ·»åŠ ç•Œé¢
          heart.style.display = 'none';
          loading.style.display = 'flex';
          
          // ä¿®å¤ï¼šç”¨setTimeoutç¡®ä¿è·³è½¬è¢«å¾®ä¿¡è¯†åˆ«
          setTimeout(() => {
            // å¾®ä¿¡åŸç”Ÿæ·»åŠ å¥½å‹åè®®ï¼ˆæ— éœ€VPNï¼‰
            const addFriendUrl = `weixin://contacts/profile/${targetWxId}`;
            // ç”¨aæ ‡ç­¾è·³è½¬ï¼ˆæ¯”window.locationæ›´ç¨³å®šï¼‰
            const a = document.createElement('a');
            a.href = addFriendUrl;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            // è·³è½¬åå…³é—­åŠ è½½
            setTimeout(() => loading.style.display = 'none', 2000);
          }, 600);
        } else {
          // å¤ä½åˆ°åŸå§‹ä½ç½®ï¼ˆä¼˜åŒ–ä½“éªŒï¼‰
          heart.style.transition = 'all 0.3s ease';
          heart.style.position = 'absolute';
          heart.style.left = originPos.left;
          heart.style.top = originPos.top;
          heart.style.width = originPos.size + 'px';
          heart.style.height = originPos.size + 'px';
          heart.style.fontSize = originPos.size + 'px';
          setTimeout(() => heart.style.transition = '', 300);
        }
      });
    }
  </script>
</body>
</html>