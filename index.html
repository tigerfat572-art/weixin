<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>å¾®ä¿¡é­”æœ¯æ·»åŠ å¥½å‹</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* å…¨å±€å˜é‡ */
    :root {
      --wx-black: #1a1a1a;
      --wx-gray: #8e8e93;
      --wx-white: #fff;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body, html {
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    /* å±‚æ§åˆ¶ï¼šé»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
    .layer {
      display: none;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* === 1. è®¾ç½®ç«¯ï¼šé…ç½®é¢æ¿ === */
    #layer-config {
      background: #f5f5f5;
      padding: 20px;
      overflow-y: auto;
      z-index: 999;
      display: block;
    }
    .cfg-title {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .warning-box {
      background: #fffbe6;
      border: 1px solid #ffe58f;
      padding: 10px;
      font-size: 12px;
      color: #d48806;
      margin-bottom: 15px;
      border-radius: 4px;
      line-height: 1.5;
    }
    .cfg-group {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .cfg-label {
      display: block;
      font-size: 14px;
      font-weight: bold;
      color: #555;
      margin-bottom: 8px;
    }
    .cfg-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .btn-start {
      width: 100%;
      padding: 15px;
      background: #07c160;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
    }

    /* === 2. è®¾ç½®ç«¯ï¼šå‡äºŒç»´ç ç•Œé¢ï¼ˆè§‚ä¼—çœ‹çš„äºŒç»´ç ç•Œé¢ï¼‰ === */
    #layer-display {
      background: var(--wx-white);
      flex-direction: column;
      z-index: 100;
    }
    .display-nav {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      margin-top: env(safe-area-inset-top);
    }
    .icon-back {
      width: 12px;
      height: 12px;
      border-left: 2px solid #000;
      border-bottom: 2px solid #000;
      transform: rotate(45deg);
    }
    .icon-more {
      width: 24px;
      height: 24px;
      background-image: radial-gradient(circle, #000 2px, transparent 0);
      background-size: 8px 100%;
    }
    .display-card {
      padding: 30px 40px 10px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .display-avatar {
      width: 64px;
      height: 64px;
      border-radius: 6px;
      background: #eee center/cover;
      flex-shrink: 0;
    }
    .display-info h2 {
      font-size: 22px;
      font-weight: 600;
      color: #000;
      margin-bottom: 5px;
    }
    .display-info p {
      font-size: 14px;
      color: #7f7f7f;
    }
    .display-qr-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding-bottom: 80px;
    }
    .qr-frame {
      width: 280px;
      height: 280px;
      position: relative;
    }
    .wx-logo {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 44px;
      height: 44px;
      background: #fff;
      border-radius: 6px;
      border: 4px solid #fff;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .display-tips {
      margin-top: 25px;
      color: #b2b2b2;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    .display-bottom-menu {
      position: absolute;
      bottom: 40px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 50px;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .menu-item {
      color: #576b95;
      font-size: 14px;
      font-weight: 500;
    }

    /* === 3. è§‚ä¼—ç«¯ï¼šå‡æ·»åŠ å¥½å‹ç•Œé¢ï¼ˆå’Œä½ ç»™çš„å›¾å®Œå…¨ä¸€è‡´ï¼‰ === */
    #layer-magic {
      background: var(--wx-black);
      color: var(--wx-white);
      z-index: 50;
    }
    .magic-nav {
      height: 44px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .magic-nav .icon-back {
      border-left: 2px solid var(--wx-white);
      border-bottom: 2px solid var(--wx-white);
    }
    .magic-nav .icon-more {
      background-image: radial-gradient(circle, var(--wx-white) 2px, transparent 0);
      margin-left: auto;
    }
    .magic-header {
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .magic-avatar {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: #eee center/cover;
    }
    .magic-user-info h2 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .verify-icon {
      width: 16px;
      height: 16px;
      background: url('https://img.icons8.com/fluency/48/00b4ff/verified-account.png') center/cover;
    }
    .magic-user-info p {
      font-size: 14px;
      color: var(--wx-gray);
      margin-top: 3px;
    }
    .magic-list {
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .magic-list-item {
      height: 50px;
      display: flex;
      align-items: center;
      padding: 0 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .item-label {
      font-size: 16px;
      color: var(--wx-gray);
      width: 80px;
    }
    .item-content {
      flex: 1;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .item-arrow {
      color: var(--wx-gray);
      font-family: monospace;
      font-weight: bold;
      transform: scaleY(1.5);
    }
    /* çº¢å¿ƒå…ƒç´ ï¼ˆæ”¾åœ¨ä¸ªæ€§ç­¾ååŒºåŸŸï¼‰ */
    .sign-box {
      position: relative;
      width: 100%;
    }
    .magic-sign {
      width: 100%;
    }
    .heart {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      font-size: 20px;
      line-height: 1;
      cursor: move;
      touch-action: none;
      z-index: 1000;
    }
    .heart::after {
      content: "â¤ï¸";
    }
    /* æ·»åŠ åˆ°é€šè®¯å½•æŒ‰é’® */
    .add-btn {
      margin: 20px 15px;
      height: 45px;
      background: #333;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 17px;
      color: var(--wx-gray);
    }
    /* åŠ è½½å±‚ */
    .loading-mask {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26,26,26,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    .spinner {
      width: 30px;
      height: 30px;
      border: 3px solid #444;
      border-top-color: var(--wx-white);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loading-text {
      margin-top: 15px;
      font-size: 14px;
      color: #ccc;
    }
  </style>
</head>
<body>

  <!-- 1. è®¾ç½®ç«¯ï¼šé…ç½®é¢æ¿ -->
  <div id="layer-config" class="layer">
    <div class="cfg-title">ğŸ› ï¸ å¾®ä¿¡é­”æœ¯é…ç½®</div>
    <div class="warning-box">
      âš ï¸ è¯·å°†æ–‡ä»¶ä¸Šä¼ åˆ°<b>HTTPSæœåŠ¡å™¨</b>ï¼ˆå¦‚Netlify/Vercelï¼‰ï¼Œå¾®ä¿¡ä»…æ”¯æŒHTTPSæ‰«ç ï¼
    </div>
    <div class="cfg-group">
      <label class="cfg-label">å¤´åƒé“¾æ¥ï¼ˆç½‘ç»œURLï¼‰</label>
      <input type="text" id="cfg-avatar" class="cfg-input" value="https://example.com/avatar.jpg" placeholder="https://...">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">æ˜µç§°</label>
      <input type="text" id="cfg-name" class="cfg-input" value="å†¯å”éª">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">åœ°åŒº</label>
      <input type="text" id="cfg-region" class="cfg-input" value="æµ™æ±Ÿ æ­å·">
    </div>
    <div class="cfg-group">
      <label class="cfg-label">ä¸ªæ€§ç­¾å</label>
      <input type="text" id="cfg-sign" class="cfg-input" value="æˆ‘çˆ±æœæ±ï¼Œæˆ‘çˆ±æœæ±ï¼Œæˆ‘çˆ±æœæ±">
    </div>
    <div class="cfg-group" style="border:1px solid #07c160;">
      <label class="cfg-label" style="color:#07c160">çœŸå®å¾®ä¿¡å·/IDï¼ˆå¿…å¡«ï¼‰</label>
      <input type="text" id="cfg-target" class="cfg-input" placeholder="ä¾‹å¦‚ï¼šwxid_123456789">
    </div>
    <button class="btn-start" onclick="generateFakeQR()">ç”Ÿæˆå‡äºŒç»´ç ç•Œé¢</button>
  </div>

  <!-- 2. è®¾ç½®ç«¯ï¼šå‡äºŒç»´ç ç•Œé¢ï¼ˆç»™è§‚ä¼—æ‰«çš„ç•Œé¢ï¼‰ -->
  <div id="layer-display" class="layer">
    <div class="display-nav">
      <div class="icon-back" onclick="location.reload()"></div>
      <div class="icon-more"></div>
    </div>
    <div class="display-card">
      <div class="display-avatar" id="display-avatar"></div>
      <div class="display-info">
        <h2 id="display-name"></h2>
        <p id="display-region"></p>
      </div>
    </div>
    <div class="display-qr-area">
      <div class="qr-frame">
        <div id="qrcode-container"></div>
        <div class="wx-logo">
          <svg width="30" height="30" viewBox="0 0 28 28" fill="#191919">
            <path d="M10.5 17.5c-5.8 0-10.5-3.9-10.5-8.75S4.7 0 10.5 0c5.8 0 10.5 3.9 10.5 8.75 0 1.05-.2 2.05-.6 3L23 15l-3.2-1.6c-1.3.8-2.8 1.3-4.4 1.3h-4.9zM20 18.5c0-3.3-3.1-6-7-6s-7 2.7-7 6c0 3.3 3.1 6 7 6 1.3 0 2.5-.3 3.5-.9L20 26l-1-2.4c2.4-1 4-2.8 4-5.1z"/>
          </svg>
        </div>
      </div>
      <div class="display-tips">æ‰«ä¸€æ‰«ä¸Šé¢çš„äºŒç»´ç å›¾æ¡ˆï¼ŒåŠ æˆ‘ä¸ºæœ‹å‹ã€‚</div>
    </div>
    <div class="display-bottom-menu">
      <span class="menu-item">æ‰«ä¸€æ‰«</span>
      <span class="menu-item">æ¢ä¸ªæ ·å¼</span>
      <span class="menu-item">ä¿å­˜å›¾ç‰‡</span>
    </div>
  </div>

  <!-- 3. è§‚ä¼—ç«¯ï¼šå‡æ·»åŠ å¥½å‹ç•Œé¢ï¼ˆå’Œä½ ç»™çš„å›¾å®Œå…¨ä¸€è‡´ï¼‰ -->
  <div id="layer-magic" class="layer">
    <div class="magic-nav">
      <div class="icon-back" onclick="history.back()"></div>
      <div class="icon-more"></div>
    </div>
    <div class="magic-header">
      <div class="magic-avatar" id="magic-avatar"></div>
      <div class="magic-user-info">
        <h2 id="magic-name">å†¯å”éª <div class="verify-icon"></div></h2>
        <p id="magic-region">åœ°åŒº: æµ™æ±Ÿ æ­å·</p>
      </div>
    </div>
    <div class="magic-list">
      <div class="magic-list-item">
        <div class="item-label">æœ‹å‹èµ„æ–™</div>
        <div class="item-content">
          <span></span>
          <span class="item-arrow">></span>
        </div>
      </div>
      <div class="magic-list-item">
        <div class="item-label">ç­¾å</div>
        <div class="item-content">
          <div class="sign-box">
            <div class="magic-sign" id="magic-sign">æˆ‘çˆ±æœæ±ï¼Œæˆ‘çˆ±æœæ±ï¼Œæˆ‘çˆ±æœæ±</div>
            <div class="heart" id="magic-heart"></div>
          </div>
          <span class="item-arrow">></span>
        </div>
      </div>
      <div class="magic-list-item">
        <div class="item-label">æœ‹å‹åœˆ</div>
        <div class="item-content">
          <span></span>
          <span class="item-arrow">></span>
        </div>
      </div>
      <div class="magic-list-item">
        <div class="item-label">è§†é¢‘å·</div>
        <div class="item-content">
          <span id="magic-videoid">å†¯å”éª</span>
          <span class="item-arrow">></span>
        </div>
      </div>
    </div>
    <div class="add-btn">æ·»åŠ åˆ°é€šè®¯å½•</div>
    <div class="loading-mask" id="loading-mask">
      <div class="spinner"></div>
      <div class="loading-text">æ­£åœ¨è·³è½¬...</div>
    </div>
  </div>

  <script>
    // é¡µé¢åŠ è½½æ—¶åˆ¤æ–­æ¨¡å¼ï¼ˆè®¾ç½®ç«¯/è§‚ä¼—ç«¯ï¼‰
    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const magicData = params.get('data');
      if (magicData) {
        // è§‚ä¼—ç«¯ï¼šè§£ææ•°æ®å¹¶æ˜¾ç¤ºå‡ç•Œé¢
        initMagicInterface(magicData);
      } else {
        // è®¾ç½®ç«¯ï¼šæ˜¾ç¤ºé…ç½®é¢æ¿
        document.getElementById('layer-config').style.display = 'block';
      }
    };

    // è®¾ç½®ç«¯ï¼šç”Ÿæˆå‡äºŒç»´ç ç•Œé¢
    function generateFakeQR() {
      // è·å–é…ç½®ä¿¡æ¯
      const config = {
        avatar: document.getElementById('cfg-avatar').value,
        name: document.getElementById('cfg-name').value,
        region: document.getElementById('cfg-region').value,
        sign: document.getElementById('cfg-sign').value,
        target: document.getElementById('cfg-target').value,
        videoid: document.getElementById('cfg-name').value // è§†é¢‘å·é»˜è®¤åŒæ˜µç§°
      };

      // éªŒè¯å¿…å¡«é¡¹
      if (!config.target) {
        alert('è¯·å¡«å†™çœŸå®å¾®ä¿¡å·/IDï¼');
        return;
      }

      // æ¸²æŸ“è®¾ç½®ç«¯çš„å‡äºŒç»´ç ç•Œé¢
      document.getElementById('display-avatar').style.backgroundImage = `url('${config.avatar}')`;
      document.getElementById('display-name').textContent = config.name;
      document.getElementById('display-region').textContent = config.region;

      // ç¼–ç é…ç½®ä¿¡æ¯ï¼ˆURLå®‰å…¨ï¼‰
      const encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(config))));
      const magicUrl = `${window.location.origin}${window.location.pathname}?data=${encodedData}`;

      // ç”ŸæˆäºŒç»´ç 
      document.getElementById('qrcode-container').innerHTML = '';
      new QRCode(document.getElementById('qrcode-container'), {
        text: magicUrl,
        width: 280,
        height: 280,
        colorDark: '#000',
        colorLight: '#fff',
        correctLevel: QRCode.CorrectLevel.H
      });

      // åˆ‡æ¢åˆ°å‡äºŒç»´ç ç•Œé¢
      document.getElementById('layer-config').style.display = 'none';
      document.getElementById('layer-display').style.display = 'flex';
    }

    // è§‚ä¼—ç«¯ï¼šåˆå§‹åŒ–å‡æ·»åŠ å¥½å‹ç•Œé¢
    function initMagicInterface(encodedData) {
      try {
        // è§£ç é…ç½®ä¿¡æ¯
        const config = JSON.parse(decodeURIComponent(escape(atob(encodedData))));

        // æ¸²æŸ“å‡ç•Œé¢å†…å®¹ï¼ˆå’Œè®¾ç½®çš„ä¿¡æ¯ä¸€è‡´ï¼‰
        document.getElementById('magic-avatar').style.backgroundImage = `url('${config.avatar}')`;
        document.getElementById('magic-name').innerHTML = `${config.name} <div class="verify-icon"></div>`;
        document.getElementById('magic-region').textContent = `åœ°åŒº: ${config.region}`;
        document.getElementById('magic-sign').textContent = config.sign;
        document.getElementById('magic-videoid').textContent = config.videoid;

        // æ˜¾ç¤ºå‡ç•Œé¢
        document.getElementById('layer-magic').style.display = 'block';
        document.title = 'è¯¦ç»†èµ„æ–™';

        // åˆå§‹åŒ–çº¢å¿ƒäº¤äº’é€»è¾‘
        initHeartInteraction(config.target);
      } catch (e) {
        alert('äºŒç»´ç æ— æ•ˆï¼Œè¯·é‡æ–°ç”Ÿæˆï¼');
        console.error(e);
      }
    }

    // è§‚ä¼—ç«¯ï¼šçº¢å¿ƒäº¤äº’+è·³è½¬çœŸå®ç•Œé¢
    function initHeartInteraction(targetWxId) {
      const heart = document.getElementById('magic-heart');
      const loading = document.getElementById('loading-mask');
      let isDragging = false;
      const originStyle = { // çº¢å¿ƒåŸå§‹æ ·å¼ï¼ˆç”¨äºå¤ä½ï¼‰
        position: heart.style.position,
        right: heart.style.right,
        top: heart.style.top,
        width: '20px',
        height: '20px',
        fontSize: '20px'
      };

      // ç‚¹å‡»çº¢å¿ƒæ”¾å¤§
      heart.addEventListener('click', function() {
        let size = parseInt(window.getComputedStyle(this).fontSize);
        if (size < 100) {
          size += 15;
          this.style.width = size + 'px';
          this.style.height = size + 'px';
          this.style.fontSize = size + 'px';
        }
      });

      // è§¦æ‘¸å¼€å§‹ï¼šæ¿€æ´»æ‹–æ‹½
      heart.addEventListener('touchstart', function(e) {
        isDragging = true;
        const rect = this.getBoundingClientRect();
        // åˆ‡æ¢ä¸ºfixedå®šä½ï¼Œæ–¹ä¾¿å…¨å±æ‹–æ‹½
        this.style.position = 'fixed';
        this.style.right = 'auto';
        this.style.top = rect.top + 'px';
        this.style.left = rect.left + 'px';
      }, { passive: false });

      // è§¦æ‘¸ç§»åŠ¨ï¼šè·Ÿéšæ‰‹æŒ‡
      heart.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
        const touch = e.touches[0];
        this.style.left = touch.clientX + 'px';
        this.style.top = touch.clientY + 'px';
      }, { passive: false });

      // è§¦æ‘¸ç»“æŸï¼šåˆ¤æ–­æ˜¯å¦æ‹–å‡ºå±å¹•
      heart.addEventListener('touchend', function() {
        if (!isDragging) return;
        isDragging = false;

        const rect = this.getBoundingClientRect();
        const winWidth = window.innerWidth;
        const winHeight = window.innerHeight;
        // åˆ¤æ–­æ˜¯å¦æ‹–å‡ºå±å¹•è¾¹ç•Œ
        const isOutOfScreen = rect.left < 0 || rect.right > winWidth || rect.top < 0 || rect.bottom > winHeight;

        if (isOutOfScreen) {
          // æ‹–å‡ºå±å¹•ï¼šæ‰§è¡Œè·³è½¬
          this.style.display = 'none';
          loading.style.display = 'flex';

          // å»¶è¿Ÿè·³è½¬ï¼ˆæ¨¡æ‹ŸåŠ è½½ï¼‰
          setTimeout(function() {
            // å¾®ä¿¡åŸç”Ÿæ·»åŠ å¥½å‹åè®®ï¼ˆæ— éœ€VPNï¼‰
            window.location.href = `weixin://contacts/profile/${targetWxId}`;
            // 2ç§’åéšè—åŠ è½½å±‚
            setTimeout(function() {
              loading.style.display = 'none';
            }, 2000);
          }, 600);
        } else {
          // æœªæ‹–å‡ºå±å¹•ï¼šå¤ä½çº¢å¿ƒ
          this.style.transition = 'all 0.3s ease';
          Object.assign(this.style, originStyle);
          setTimeout(() => { this.style.transition = ''; }, 300);
        }
      });
    }
  </script>
</body>
</html>